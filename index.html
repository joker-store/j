<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>استعلام الرصيد</title>
  <style>
    body { font-family: Tahoma; text-align: center; padding: 50px; background: #f8f8f8; }
    input { padding: 10px; margin: 5px; }
    button { padding: 10px 20px; }
    #balanceBox { display: none; background: white; padding: 20px; margin-top: 20px; border-radius: 10px; }
  </style>
</head>
<body>

  <h2>تسجيل الدخول</h2>
  <input type="text" id="username" placeholder="اسم المستخدم"><br>
  <input type="password" id="password" placeholder="كلمة المرور"><br>
  <button onclick="login()">دخول</button>
  <p id="error" style="color:red"></p>

  <div id="balanceBox">
    <h3>أهلاً <span id="clientName"></span></h3>
    <h2>رصيدك الحالي: <span id="balance"></span> ج.م</h2>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDZQJZnekkDRf6jGIplVFlx0MckFR-xed8",
      authDomain: "ahmed-77878.firebaseapp.com",
      databaseURL: "https://ahmed-77878-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ahmed-77878",
      storageBucket: "ahmed-77878.firebasestorage.app",
      messagingSenderId: "566732207368",
      appId: "1:566732207368:web:d88477f62ecf475e2628bd",
      measurementId: "G-NTBFNP3PLF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;

      // هنجيب بيانات اليوزر من جدول users الجديد
      const snapshot = await db.ref('users/' + user).once('value');
      if (!snapshot.exists()) return document.getElementById('error').innerText = 'المستخدم غير موجود';

      const data = snapshot.val();
      if (data.password !== pass) return document.getElementById('error').innerText = 'كلمة المرور خطأ';

      // ✅ لو الدخول صحيح نعرض الرصيد من debts
      document.getElementById('error').innerText = '';
      document.getElementById('clientName').innerText = data.name;
      document.getElementById('balanceBox').style.display = 'block';

      // حساب الرصيد من مجلد clients
      const debtsSnap = await db.ref('clients/' + data.id + '/debts').once('value');
      let total = 0;
      debtsSnap.forEach(child => {
        const debt = child.val();
        total += parseFloat(debt.amount);
      });
      document.getElementById('balance').innerText = total;
    }
  </script>
</body>
</html>
